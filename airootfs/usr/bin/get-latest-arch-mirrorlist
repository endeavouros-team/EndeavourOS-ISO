#!/bin/bash

# Fetch the list of currently active mirrors from the Arch web site.
# Save the list into file $file.

echo2()  { echo "$@" >&2; }
WARN()   { echo2 "==> $progname: warning: $1"; }
DIE()    { echo2 "==> $progname: error: $1"; exit 1; }
ASSERT() { "$@" || DIE "'$*' failed."; }

Main()
{
    local -r progname=${0##*/}
    local -r url=https://archlinux.org/mirrorlist/all/   # mirrors active at the time listed in the file, both https and http
    local -r file=mirrors-arch-latest-active
    local -r tmp=$file.tmp
    local operation=update

    if wget --timeout=30 -qO "$tmp" "$url" ; then
        ASSERT rm -f "$tmp.2"
        [ -e "$file" ] && ASSERT mv "$file" "$tmp.2" || operation=create
        ASSERT mv "$tmp" "$file"
        rm -f "$tmp.2"
        echo2 "==> ${operation^}d $file."
        exit 0
    else
        rm -f "$tmp"
        [ -e "$file" ] || operation=create
        WARN "could not $operation $file."
        exit 1
    fi
}

Main "$@"
