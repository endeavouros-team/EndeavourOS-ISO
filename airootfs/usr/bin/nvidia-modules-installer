#!/bin/bash
set -euo pipefail

# Check bootflag
if ! grep -qw "nvidia=1" /proc/cmdline; then
    echo "Bootflag nvidia=1 not set – skipping."
    exit 0
fi

echo "Bootflag nvidia=1 found – detecting NVIDIA driver support..."

driver_type="$(/usr/bin/eos-hwtool --check-nvidia)"

# We ONLY support nvidia-open.
# If the GPU requires proprietary nvidia, fall back to nouveau (do nothing).
if [ "$driver_type" != "nvidia-open" ]; then
    echo "nvidia-open not supported on this GPU (detected: $driver_type) – keeping nouveau."
    exit 0
fi

pkg_pattern="/usr/share/packages/nvidia-open-[0-9]*.pkg.tar.zst"
pkg_files=($pkg_pattern)

if [ "${pkg_files[0]}" = "$pkg_pattern" ]; then
    echo "Error: nvidia-open packages not found."
    exit 1
fi

echo "Unloading NVIDIA modules (if any)..."
mod_list=(nvidia_drm nvidia_uvm nvidia_modeset nvidia)
for mod in "${mod_list[@]}"; do
    modprobe -r "$mod" 2>/dev/null || true
done

echo "Unloading nouveau modules (if any)..."
mod_list=(nouveau nouveau_drm)
for mod in "${mod_list[@]}"; do
    modprobe -r "$mod" 2>/dev/null || true
done

echo "Installing nvidia-open package..."
pacman -U --noconfirm "${pkg_files[@]}"

echo "Loading NVIDIA modules..."
modprobe nvidia
modprobe nvidia_modeset
modprobe nvidia_uvm
modprobe nvidia_drm

echo "setting Nvidia GL to be used for the live session"
export __GLX_VENDOR_LIBRARY_NAME=nvidia

echo "NVIDIA setup done."
